var kinopub=function(e){var t={};function i(n){if(t[n])return t[n].exports;var s=t[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=e,i.c=t,i.d=function(e,t,n){i.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:n})},i.r=function(e){Object.defineProperty(e,"__esModule",{value:!0})},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=0)}([function(e,t,i){"use strict";i.r(t);class n{removeItem(e){window.localStorage.removeItem(e)}getItem(e){let t=window.localStorage.getItem(e)||"{}",i=JSON.parse(t);return!!i&&(i.expire&&(Date.now(),i.expire),i.value)}setItem(e,t,i){let n={value:t};i&&(n.expire=Date.now()+1e3*i),window.localStorage.setItem(e,JSON.stringify(n))}}class s{log(){console.log.apply(console,arguments)}}const o=(e,t)=>{let i=new window.URLSearchParams;for(let e in t)i.append(e,t[e]);return fetch(e,{body:i,method:"POST"}).then(e=>e.json()).catch(e=>{console.error(e)})};class r extends s{clearTokens(){["access_token","refresh_token"].forEach(this.storage.removeItem)}saveTokens(e){switch(this.clearTokens(),e.error){case"authorization_pending":this.log("authorization_pending");break;case void 0:const{access_token:t,expires_in:i,refresh_token:n}=e;this.storage.setItem("access_token",t,i),this.storage.setItem("refresh_token",n,2592e3),this.clearTimers(),this.onSuccess(t),this.notify();break;default:this.log("Critical error",e),this.clearTimers()}}checkDeviceCode(e,t){o(`${this.apiEndpoint}/oauth2/device`,{grant_type:"device_token",client_id:this.appInfo.client.id,client_secret:this.appInfo.client.secret,code:e}).then(this.saveTokens.bind(this))}getDeviceCode(){o(`${this.apiEndpoint}/oauth2/device`,{grant_type:"device_code",client_id:this.appInfo.client.id,client_secret:this.appInfo.client.secret}).then((e=>{const{code:t,expires_in:i,interval:n,user_code:s,verification_uri:o}=e;this.onConfirm(s,o),this.checkDeviceCodeIntervaId=setInterval(this.checkDeviceCode.bind(this,t),1e3*n),this.clearTokenTimeoutId=setTimeout(this.init.bind(this,onConfirm),1e3*i)}).bind(this))}notify(){const e=this.getAccessToken();o(`${this.apiEndpoint}/v1/device/notify?access_token=${e}`,this.appInfo.appInfo)}getAccessToken(){return this.storage.getItem("access_token")}getRefreshToken(){return this.storage.getItem("refresh_token")}clearTimers(){clearInterval(this.checkDeviceCodeIntervaId),clearTimeout(this.clearTokenTimeoutId),this.checkDeviceCodeIntervaId=0,this.clearTokenTimeoutId=0}constructor(e,t,i){super();const s=()=>this.log("onConfirm or onSuccess not implemented");this.onConfirm=t||s,this.onSuccess=i||s,this.clearTimers(),this.appInfo=e,this.storage=new n,this.apiEndpoint="https://api.service-kp.com",this.init()}refreshToken(){o(`${this.apiEndpoint}/oauth2/token`,{grant_type:"refresh_token",client_id:this.appInfo.client.id,client_secret:this.appInfo.client.secret,refresh_token:this.getRefreshToken()}).then(this.saveTokens.bind(this))}init(){const e=this.getAccessToken(),t=this.getRefreshToken();this.clearTimers(),e?(this.notify(),this.onSuccess(e)):t?this.refreshToken():this.getDeviceCode()}}i.d(t,"Api",function(){return c});class c{constructor(e,t,i={}){this.apiHostUrl="https://api.service-kp.com/v1",this.info={client:{id:"xbmc",secret:"cgg3gtifu46urtfp2zp1nqtba0k2ezxh"},appInfo:{title:"Kinopub Webos player",hardware:"LG C7",software:"https://github.com/nurikk/kinopub"}},this.auth=new r(this.info,e,t)}}}]);